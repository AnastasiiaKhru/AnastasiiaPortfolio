@using System.Linq
@model List<PlayerScore>
@{
    ViewData["Title"] = "Snake Game";
    Layout = null;
    var topScores = (ViewBag.TopScores as IEnumerable<PlayerScore>)?.ToList() ?? new List<PlayerScore>();
    var displayScores = topScores.OrderByDescending(s => s.Score).Take(3).ToList();
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Snake - PlayZone | Anastasiia Portfolio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            min-height: 100vh;
            font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
            background: #030508;
            color: #f1f5f9;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-animation {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background: 
                radial-gradient(circle at 30% 70%, rgba(0, 255, 136, 0.06) 0%, transparent 45%),
                radial-gradient(circle at 70% 30%, rgba(34, 197, 94, 0.05) 0%, transparent 45%),
                radial-gradient(circle at 50% 50%, rgba(0, 200, 100, 0.03) 0%, transparent 60%);
            animation: bgRotate 40s linear infinite;
        }

        @@keyframes bgRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Grid overlay */
        .grid-overlay {
            position: fixed;
            inset: 0;
            z-index: 1;
            background-image: 
                linear-gradient(rgba(0, 255, 136, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 136, 0.02) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
        }

        /* Navigation */
        .game-nav {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(5, 10, 15, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(0, 255, 136, 0.15);
            border-radius: 1rem;
        }

        .game-nav__link {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            border-radius: 0.6rem;
            color: #64748b;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .game-nav__link:hover {
            color: #f1f5f9;
            background: rgba(255, 255, 255, 0.05);
        }

        .game-nav__link--active {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(34, 197, 94, 0.15));
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        /* Main container */
        .snake-game {
            position: relative;
            z-index: 10;
            min-height: 100vh;
            padding: 5rem 1rem 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Game header */
        .game-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .game-title {
            font-family: 'Orbitron', sans-serif;
            font-size: clamp(2rem, 6vw, 3rem);
            font-weight: 800;
            background: linear-gradient(135deg, #00ff88, #22c55e, #4ade80);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
            text-shadow: 0 0 40px rgba(0, 255, 136, 0.3);
        }

        @@keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Main layout */
        .game-layout {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            width: 100%;
            max-width: 900px;
            align-items: center;
        }

        @@media (min-width: 800px) {
            .game-layout {
                flex-direction: row;
                align-items: flex-start;
            }
        }

        /* Game area */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            width: 100%;
            max-width: 500px;
        }

        /* Score HUD */
        .score-hud {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .score-item {
            background: linear-gradient(165deg, rgba(10, 20, 15, 0.9), rgba(5, 10, 8, 0.95));
            border: 1px solid rgba(0, 255, 136, 0.15);
            border-radius: 0.75rem;
            padding: 0.6rem 1rem;
            text-align: center;
            min-width: 80px;
            transition: all 0.2s;
        }

        .score-item:hover {
            border-color: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }

        .score-item--combo {
            border-color: rgba(251, 146, 60, 0.4);
            animation: comboPulse 0.8s ease-in-out infinite;
        }

        @@keyframes comboPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 146, 60, 0.2); }
            50% { box-shadow: 0 0 25px rgba(251, 146, 60, 0.4); }
        }

        .score-label {
            display: block;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-bottom: 0.2rem;
        }

        .score-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.25rem;
            font-weight: 700;
            color: #00ff88;
        }

        .score-item--best .score-value { color: #fbbf24; }
        .score-item--level .score-value { color: #60a5fa; }
        .score-item--combo .score-value { color: #fb923c; }

        /* Canvas container */
        .canvas-container {
            position: relative;
            border-radius: 1rem;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(34, 197, 94, 0.05));
            padding: 3px;
        }

        .canvas-inner {
            position: relative;
            border-radius: 0.85rem;
            overflow: hidden;
            background: #030806;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            max-width: 450px;
            aspect-ratio: 1;
            border-radius: 0.85rem;
        }

        /* Pause overlay */
        .pause-overlay {
            position: absolute;
            inset: 0;
            background: rgba(3, 8, 6, 0.92);
            backdrop-filter: blur(8px);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            border-radius: 0.85rem;
        }

        .pause-overlay.active { display: flex; }

        .pause-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: #00ff88;
        }

        .btn-resume {
            background: linear-gradient(135deg, #00ff88, #22c55e);
            color: #030806;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 0.5rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-resume:hover {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0, 255, 136, 0.4);
        }

        /* Controls help */
        .controls-help {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .control-hint {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.1);
            border-radius: 0.4rem;
            font-size: 0.75rem;
            color: #64748b;
        }

        .control-hint kbd {
            background: rgba(0, 255, 136, 0.15);
            padding: 0.1rem 0.35rem;
            border-radius: 0.2rem;
            font-family: 'Consolas', monospace;
            font-size: 0.7rem;
            color: #00ff88;
        }

        /* Mobile D-Pad */
        .d-pad {
            display: none;
            width: 150px;
            height: 150px;
            margin-top: 1rem;
            position: relative;
        }

        .d-pad-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            background: linear-gradient(165deg, rgba(0, 255, 136, 0.15), rgba(0, 200, 100, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 0.5rem;
            color: #00ff88;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.15s;
            -webkit-tap-highlight-color: transparent;
        }

        .d-pad-btn:active {
            background: rgba(0, 255, 136, 0.3);
            transform: scale(0.95);
        }

        .d-pad-up { top: 0; left: 50px; }
        .d-pad-down { bottom: 0; left: 50px; }
        .d-pad-left { top: 50px; left: 0; }
        .d-pad-right { top: 50px; right: 0; }

        /* Sidebar */
        .sidebar {
            width: 100%;
            max-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        @@media (min-width: 800px) {
            .sidebar {
                position: sticky;
                top: 5rem;
            }
        }

        /* Leaderboard */
        .leaderboard {
            background: linear-gradient(165deg, rgba(10, 20, 15, 0.85), rgba(5, 10, 8, 0.9));
            border: 1px solid rgba(0, 255, 136, 0.12);
            border-radius: 1rem;
            padding: 1.25rem;
        }

        .leaderboard-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            color: #00ff88;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .leader-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(0, 255, 136, 0.03);
            border: 1px solid rgba(0, 255, 136, 0.08);
            border-radius: 0.6rem;
            transition: all 0.2s;
        }

        .leader-item:hover {
            border-color: rgba(0, 255, 136, 0.2);
            background: rgba(0, 255, 136, 0.06);
        }

        .leader-rank {
            width: 28px;
            height: 28px;
            border-radius: 0.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 0.8rem;
        }

        .leader-item:nth-child(1) .leader-rank {
            background: linear-gradient(135deg, #fbbf24, #d97706);
            color: #030806;
        }

        .leader-item:nth-child(2) .leader-rank {
            background: linear-gradient(135deg, #94a3b8, #64748b);
            color: #030806;
        }

        .leader-item:nth-child(3) .leader-rank {
            background: linear-gradient(135deg, #d97706, #92400e);
            color: #fff;
        }

        .leader-info {
            flex: 1;
        }

        .leader-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #e2e8f0;
        }

        .leader-score {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: #00ff88;
        }

        /* Name dialog */
        .name-dialog {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(3, 5, 8, 0.9);
            backdrop-filter: blur(16px);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .name-dialog.hidden { display: none; }

        @@keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .dialog-content {
            background: linear-gradient(165deg, rgba(10, 25, 18, 0.95), rgba(5, 12, 10, 0.98));
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 1.5rem;
            padding: 2.5rem 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: dialogPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            overflow: hidden;
        }

        .dialog-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00ff88, #22c55e, #4ade80, #00ff88);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
        }

        @@keyframes shimmer {
            from { background-position: 0% 50%; }
            to { background-position: 200% 50%; }
        }

        @@keyframes dialogPop {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .snake-animation {
            display: flex;
            justify-content: center;
            gap: 0.3rem;
            margin-bottom: 1.5rem;
        }

        .snake-dot {
            width: 12px;
            height: 12px;
            background: linear-gradient(135deg, #00ff88, #22c55e);
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.5);
            animation: snakeBounce 1.2s ease-in-out infinite;
        }

        .snake-dot:nth-child(1) { animation-delay: 0s; }
        .snake-dot:nth-child(2) { animation-delay: 0.1s; }
        .snake-dot:nth-child(3) { animation-delay: 0.2s; }
        .snake-dot:nth-child(4) { animation-delay: 0.3s; }
        .snake-dot:nth-child(5) { animation-delay: 0.4s; }

        @@keyframes snakeBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-8px) scale(1.1); }
        }

        .dialog-back-link {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            color: #64748b;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .dialog-back-link:hover {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .dialog-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.6rem;
            font-weight: 800;
            color: #00ff88;
            margin-bottom: 0.5rem;
        }

        .dialog-subtitle {
            color: #94a3b8;
            font-size: 0.95rem;
            margin-bottom: 1.5rem;
        }

        .input-group {
            margin-bottom: 1.25rem;
        }

        .input-label {
            display: block;
            text-align: left;
            font-size: 0.8rem;
            font-weight: 600;
            color: #94a3b8;
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .name-input {
            width: 100%;
            background: rgba(0, 255, 136, 0.05);
            border: 2px solid rgba(0, 255, 136, 0.2);
            color: #f1f5f9;
            border-radius: 0.6rem;
            padding: 0.85rem 1rem;
            font-size: 1rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: all 0.2s;
        }

        .name-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 0 4px rgba(0, 255, 136, 0.15);
        }

        .name-input::placeholder { color: #475569; }

        .name-input.error {
            border-color: #ef4444;
            animation: shake 0.4s ease;
        }

        @@keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-6px); }
            40% { transform: translateX(6px); }
            60% { transform: translateX(-4px); }
            80% { transform: translateX(4px); }
        }

        .btn-start {
            width: 100%;
            background: linear-gradient(135deg, #00ff88, #22c55e);
            color: #030806;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 0.6rem;
            font-family: 'Orbitron', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }

        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 255, 136, 0.4);
        }

        /* Game over dialog */
        .game-over-dialog {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(3, 5, 8, 0.9);
            backdrop-filter: blur(16px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .game-over-dialog.active { display: flex; }

        .game-over-content {
            background: linear-gradient(165deg, rgba(10, 25, 18, 0.95), rgba(5, 12, 10, 0.98));
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 1.5rem;
            padding: 2rem;
            max-width: 360px;
            width: 90%;
            text-align: center;
            animation: dialogPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .game-over-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.4rem;
            font-weight: 800;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }

        .final-score {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            color: #00ff88;
            margin: 1rem 0;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.4);
        }

        .new-high {
            display: none;
            color: #fbbf24;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .new-high.active { display: block; }

        .btn-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .back-to-menu {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.25rem;
            padding: 0.6rem 1rem;
            color: #64748b;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .back-to-menu:hover {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .btn-restart {
            flex: 1;
            background: linear-gradient(135deg, #00ff88, #22c55e);
            color: #030806;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-restart:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 255, 136, 0.3);
        }

        .btn-new-player {
            flex: 1;
            background: transparent;
            color: #f1f5f9;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-new-player:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        /* Mobile styles */
        @@media (max-width: 800px) {
            .snake-game {
                padding: 4.5rem 0.75rem 1.5rem;
            }

            .game-layout {
                gap: 1rem;
            }

            .sidebar {
                max-width: 100%;
            }

            .score-hud {
                gap: 0.5rem;
            }

            .score-item {
                min-width: 70px;
                padding: 0.5rem 0.75rem;
            }

            .score-value {
                font-size: 1.1rem;
            }
        }

        @@media (hover: none) and (pointer: coarse) {
            .d-pad { display: block; }
            .controls-help { display: none; }
        }

        @@media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
            }
        }
    </style>
</head>
<body>

<div class="bg-animation"></div>
<div class="grid-overlay"></div>

<!-- Navigation -->
<nav class="game-nav">
    <a href="/PlayZone" class="game-nav__link"><i class="fas fa-th-large"></i> Games</a>
    <a href="/PlayZone/Snake" class="game-nav__link game-nav__link--active"><i class="fas fa-gamepad"></i> Snake</a>
    <a href="/PlayZone/Maze" class="game-nav__link"><i class="fas fa-cube"></i> 3D Maze</a>
</nav>

<!-- Name Dialog -->
<div class="name-dialog" id="nameDialog">
    <div class="dialog-content">
        <a href="/PlayZone" class="dialog-back-link">
            <i class="fas fa-arrow-left"></i> Back to Games
        </a>
        <div class="snake-animation">
            <div class="snake-dot"></div>
            <div class="snake-dot"></div>
            <div class="snake-dot"></div>
            <div class="snake-dot"></div>
            <div class="snake-dot"></div>
        </div>
        <h2 class="dialog-title">Welcome to Snake!</h2>
        <p class="dialog-subtitle">Enter your name to start playing</p>
        <div class="input-group">
            <label class="input-label" for="playerNameInput">Player Name</label>
            <input type="text" id="playerNameInput" class="name-input" placeholder="e.g. Snake Master" maxlength="20" autocomplete="off" autofocus />
        </div>
        <button type="button" class="btn-start" id="startBtn">
            <i class="fas fa-play"></i> Start Game
        </button>
    </div>
</div>

<!-- Game Over Dialog -->
<div class="game-over-dialog" id="gameOverDialog">
    <div class="game-over-content">
        <h2 class="game-over-title">Game Over!</h2>
        <div class="final-score" id="finalScore">0</div>
        <p class="new-high" id="newHigh">New High Score!</p>
        <div class="btn-group">
            <button type="button" class="btn-restart" id="restartBtn">
                <i class="fas fa-redo"></i> Play Again
            </button>
            <button type="button" class="btn-new-player" id="newPlayerBtn">
                <i class="fas fa-user"></i> New Player
            </button>
        </div>
        <a href="/PlayZone" class="back-to-menu">
            <i class="fas fa-th-large"></i> Back to Games Menu
        </a>
    </div>
</div>

<!-- Main Game -->
<div class="snake-game">
    <header class="game-header">
        <h1 class="game-title">SNAKE</h1>
    </header>

    <div class="game-layout">
        <div class="game-area">
            <!-- Score HUD -->
            <div class="score-hud">
                <div class="score-item">
                    <span class="score-label">Score</span>
                    <span class="score-value" id="scoreDisplay">0</span>
                </div>
                <div class="score-item score-item--best">
                    <span class="score-label">Best</span>
                    <span class="score-value" id="bestDisplay">0</span>
                </div>
                <div class="score-item score-item--level">
                    <span class="score-label">Level</span>
                    <span class="score-value" id="levelDisplay">1</span>
                </div>
                <div class="score-item score-item--combo" id="comboItem" style="display: none;">
                    <span class="score-label">Combo</span>
                    <span class="score-value" id="comboDisplay">x2</span>
                </div>
            </div>

            <!-- Canvas -->
            <div class="canvas-container">
                <div class="canvas-inner">
                    <canvas id="gameCanvas"></canvas>
                    <div class="pause-overlay" id="pauseOverlay">
                        <p class="pause-text">PAUSED</p>
                        <button type="button" class="btn-resume" id="resumeBtn">Resume</button>
                    </div>
                </div>
            </div>

            <!-- Controls help -->
            <div class="controls-help">
                <span class="control-hint"><kbd>↑</kbd><kbd>↓</kbd><kbd>←</kbd><kbd>→</kbd> Move</span>
                <span class="control-hint"><kbd>P</kbd> Pause</span>
            </div>

            <!-- Mobile D-Pad -->
            <div class="d-pad" id="dpad">
                <button type="button" class="d-pad-btn d-pad-up" data-dir="up"><i class="fas fa-chevron-up"></i></button>
                <button type="button" class="d-pad-btn d-pad-down" data-dir="down"><i class="fas fa-chevron-down"></i></button>
                <button type="button" class="d-pad-btn d-pad-left" data-dir="left"><i class="fas fa-chevron-left"></i></button>
                <button type="button" class="d-pad-btn d-pad-right" data-dir="right"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="leaderboard">
                <h3 class="leaderboard-title"><i class="fas fa-trophy"></i> Top Players</h3>
                <div class="leaderboard-list" id="leaderboardList">
                    @foreach (var score in displayScores)
                    {
                        <div class="leader-item">
                            <div class="leader-rank">@(displayScores.IndexOf(score) + 1)</div>
                            <div class="leader-info">
                                <div class="leader-name">@score.PlayerName</div>
                            </div>
                            <div class="leader-score">@score.Score</div>
                        </div>
                    }
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elements
    const nameDialog = document.getElementById('nameDialog');
    const nameInput = document.getElementById('playerNameInput');
    const startBtn = document.getElementById('startBtn');
    const gameOverDialog = document.getElementById('gameOverDialog');
    const finalScoreEl = document.getElementById('finalScore');
    const newHighEl = document.getElementById('newHigh');
    const restartBtn = document.getElementById('restartBtn');
    const newPlayerBtn = document.getElementById('newPlayerBtn');
    const pauseOverlay = document.getElementById('pauseOverlay');
    const resumeBtn = document.getElementById('resumeBtn');
    const comboItem = document.getElementById('comboItem');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Game config
    const TILE_COUNT = 20;
    let tileSize;
    let snake = [];
    let food = {};
    let dx = 0, dy = 0;
    let score = 0;
    let bestScore = parseInt(localStorage.getItem('playzoneBest') || '0', 10);
    let gameSpeed = 140;
    let gameLoop;
    let isRunning = false;
    let isPaused = false;
    let comboCount = 0;
    let lastEatTime = 0;
    const COMBO_WINDOW = 1200;
    const COMBO_CAP = 5;
    let particles = [];
    let scorePops = [];
    let foodPhase = 0;
    let displayXs = [];
    let displayYs = [];
    let rafId = 0;
    const LERP = 0.25;

    // Initialize
    document.getElementById('bestDisplay').textContent = bestScore;
    setTimeout(() => nameInput.focus(), 300);

    // Event listeners
    startBtn.addEventListener('click', startWithName);
    nameInput.addEventListener('keypress', e => { if (e.key === 'Enter') startWithName(); });
    restartBtn.addEventListener('click', initGame);
    newPlayerBtn.addEventListener('click', showNameDialog);
    resumeBtn.addEventListener('click', togglePause);

    function startWithName() {
        const name = nameInput.value.trim();
        if (!name) {
            nameInput.classList.add('error');
            setTimeout(() => nameInput.classList.remove('error'), 500);
            return;
        }
        localStorage.setItem('playerName', name);
        nameDialog.classList.add('hidden');
        initGame();
    }

    function showNameDialog() {
        gameOverDialog.classList.remove('active');
        nameDialog.classList.remove('hidden');
        setTimeout(() => nameInput.focus(), 300);
    }

    function initGame() {
        resizeCanvas();
        snake = [{ x: Math.floor(TILE_COUNT / 2), y: Math.floor(TILE_COUNT / 2) }];
        displayXs = [snake[0].x];
        displayYs = [snake[0].y];
        dx = 1; dy = 0;
        score = 0;
        gameSpeed = 140;
        comboCount = 0;
        lastEatTime = 0;
        particles = [];
        scorePops = [];
        isRunning = true;
        isPaused = false;

        gameOverDialog.classList.remove('active');
        pauseOverlay.classList.remove('active');
        newHighEl.classList.remove('active');
        comboItem.style.display = 'none';

        generateFood();
        updateUI();

        if (gameLoop) clearInterval(gameLoop);
        gameLoop = setInterval(tick, gameSpeed);

        if (!rafId) {
            (function renderLoop() {
                if (isRunning && displayXs.length === snake.length) {
                    for (let i = 0; i < snake.length; i++) {
                        displayXs[i] += (snake[i].x - displayXs[i]) * LERP;
                        displayYs[i] += (snake[i].y - displayYs[i]) * LERP;
                    }
                }
                draw();
                rafId = requestAnimationFrame(renderLoop);
            })();
        }
    }

    function resizeCanvas() {
        const container = canvas.parentElement;
        const size = Math.min(container.clientWidth, 450);
        canvas.width = size;
        canvas.height = size;
        tileSize = size / TILE_COUNT;
    }

    function generateFood() {
        do {
            food = { x: Math.floor(Math.random() * TILE_COUNT), y: Math.floor(Math.random() * TILE_COUNT) };
        } while (snake.some(s => s.x === food.x && s.y === food.y));
    }

    function updateUI() {
        document.getElementById('scoreDisplay').textContent = score;
        document.getElementById('bestDisplay').textContent = bestScore;
        const level = 1 + Math.max(0, Math.floor((140 - gameSpeed) / 20));
        document.getElementById('levelDisplay').textContent = level;
        if (comboCount > 1) {
            comboItem.style.display = 'block';
            document.getElementById('comboDisplay').textContent = 'x' + (comboCount + 1);
        } else {
            comboItem.style.display = 'none';
        }
    }

    function spawnParticles(x, y) {
        const cx = (x + 0.5) * tileSize, cy = (y + 0.5) * tileSize;
        for (let i = 0; i < 10; i++) {
            const a = (i / 10) * Math.PI * 2 + Math.random() * 0.5;
            const v = 2.5 + Math.random() * 2.5;
            particles.push({
                x: cx, y: cy,
                vx: Math.cos(a) * v, vy: Math.sin(a) * v,
                life: 1, r: 3 + Math.random() * 4
            });
        }
    }

    function spawnScorePop(x, y, value) {
        scorePops.push({
            x: (x + 0.5) * tileSize, y: (y + 0.5) * tileSize,
            value: '+' + value, life: 1
        });
    }

    function tick() {
        if (!isRunning || isPaused) return;
        foodPhase = (foodPhase + 0.1) % (Math.PI * 2);

        const head = { x: snake[0].x + dx, y: snake[0].y + dy };

        // Collision with walls
        if (head.x < 0 || head.x >= TILE_COUNT || head.y < 0 || head.y >= TILE_COUNT) {
            gameOver();
            return;
        }

        // Collision with self
        if (snake.some(s => s.x === head.x && s.y === head.y)) {
            gameOver();
            return;
        }

        const oldHead = { x: snake[0].x, y: snake[0].y };
        snake.unshift(head);
        displayXs.unshift(oldHead.x);
        displayYs.unshift(oldHead.y);

        // Eat food
        if (head.x === food.x && head.y === food.y) {
            const now = Date.now();
            if (now - lastEatTime < COMBO_WINDOW) {
                comboCount = Math.min(comboCount + 1, COMBO_CAP - 1);
            } else {
                comboCount = 0;
            }
            lastEatTime = now;

            const pts = 10 * (1 + comboCount);
            score += pts;
            if (score > bestScore) {
                bestScore = score;
                try { localStorage.setItem('playzoneBest', String(bestScore)); } catch(e) {}
            }

            spawnParticles(food.x, food.y);
            spawnScorePop(food.x, food.y, pts);
            if (navigator.vibrate) navigator.vibrate(15);
            generateFood();

            if (gameSpeed > 50) {
                gameSpeed -= 4;
                clearInterval(gameLoop);
                gameLoop = setInterval(tick, gameSpeed);
            }
        } else {
            snake.pop();
            displayXs.pop();
            displayYs.pop();
        }

        // Update particles
        particles = particles.filter(p => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.04;
            return p.life > 0;
        });
        scorePops = scorePops.filter(s => {
            s.y -= 1.5; s.life -= 0.035;
            return s.life > 0;
        });

        updateUI();
    }

    function draw() {
        const w = canvas.width, h = canvas.height;

        // Background with radial gradient
        const bg = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w * 0.8);
        bg.addColorStop(0, '#040a08');
        bg.addColorStop(0.5, '#030806');
        bg.addColorStop(1, '#020504');
        ctx.fillStyle = bg;
        ctx.fillRect(0, 0, w, h);

        // Grid
        ctx.strokeStyle = 'rgba(0, 255, 136, 0.04)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= TILE_COUNT; i++) {
            const p = i * tileSize;
            ctx.beginPath();
            ctx.moveTo(p, 0); ctx.lineTo(p, h);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, p); ctx.lineTo(w, p);
            ctx.stroke();
        }

        // Snake
        const r = tileSize * 0.42;
        const bodyGrad = ctx.createLinearGradient(0, 0, w, h);
        bodyGrad.addColorStop(0, '#00ff88');
        bodyGrad.addColorStop(0.4, '#22c55e');
        bodyGrad.addColorStop(0.7, '#16a34a');
        bodyGrad.addColorStop(1, '#15803d');

        for (let i = snake.length - 1; i >= 0; i--) {
            const seg = snake[i];
            const sx = (displayXs[i] ?? seg.x) * tileSize + tileSize / 2;
            const sy = (displayYs[i] ?? seg.y) * tileSize + tileSize / 2;
            const isHead = i === 0;
            const rad = isHead ? r * 1.1 : r - (i % 2) * 1.5;

            ctx.save();
            ctx.fillStyle = bodyGrad;
            ctx.shadowColor = 'rgba(0, 255, 136, 0.5)';
            ctx.shadowBlur = isHead ? 18 : 8;
            ctx.beginPath();
            ctx.arc(sx, sy, Math.max(4, rad), 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;

            // Highlight
            if (rad > 5) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
                ctx.beginPath();
                ctx.ellipse(sx - rad * 0.3, sy - rad * 0.3, rad * 0.35, rad * 0.2, -0.5, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }

        // Eyes
        if (snake.length > 0) {
            const seg = snake[0];
            const sx = (displayXs[0] ?? seg.x) * tileSize + tileSize / 2;
            const sy = (displayYs[0] ?? seg.y) * tileSize + tileSize / 2;
            const eyeOff = r * 0.55;

            ctx.fillStyle = '#fff';
            const ex1 = sx + dy * eyeOff, ey1 = sy - dx * eyeOff;
            const ex2 = sx - dy * eyeOff, ey2 = sy + dx * eyeOff;

            ctx.beginPath();
            ctx.arc(ex1, ey1, r * 0.25, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(ex2, ey2, r * 0.25, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = '#030806';
            ctx.beginPath();
            ctx.arc(ex1 + dx * 2, ey1 + dy * 2, r * 0.12, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(ex2 + dx * 2, ey2 + dy * 2, r * 0.12, 0, Math.PI * 2);
            ctx.fill();
        }

        // Food
        const fx = (food.x + 0.5) * tileSize, fy = (food.y + 0.5) * tileSize;
        const pulse = 1 + 0.08 * Math.sin(foodPhase);
        const fr = (tileSize / 2.3) * pulse;

        const foodGrad = ctx.createRadialGradient(fx - fr * 0.3, fy - fr * 0.4, 0, fx, fy, fr);
        foodGrad.addColorStop(0, '#fca5a5');
        foodGrad.addColorStop(0.3, '#ef4444');
        foodGrad.addColorStop(0.7, '#dc2626');
        foodGrad.addColorStop(1, '#b91c1c');

        ctx.fillStyle = foodGrad;
        ctx.shadowColor = 'rgba(239, 68, 68, 0.6)';
        ctx.shadowBlur = 15;
        ctx.beginPath();
        ctx.arc(fx, fy, fr, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;

        // Food highlight
        ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
        ctx.beginPath();
        ctx.ellipse(fx - fr * 0.35, fy - fr * 0.3, fr * 0.25, fr * 0.15, -0.4, 0, Math.PI * 2);
        ctx.fill();

        // Food stem
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = Math.max(1.5, fr * 0.12);
        ctx.lineCap = 'round';
        ctx.beginPath();
        ctx.moveTo(fx, fy - fr * 0.85);
        ctx.quadraticCurveTo(fx + fr * 0.4, fy - fr * 1.2, fx + fr * 0.6, fy - fr * 0.9);
        ctx.stroke();

        // Particles
        particles.forEach(p => {
            ctx.fillStyle = `rgba(0, 255, 136, ${p.life})`;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r * p.life, 0, Math.PI * 2);
            ctx.fill();
        });

        // Score pops
        ctx.font = "bold 16px 'Orbitron', sans-serif";
        ctx.textAlign = 'center';
        scorePops.forEach(s => {
            ctx.fillStyle = `rgba(255, 255, 255, ${s.life})`;
            ctx.fillText(s.value, s.x, s.y);
        });
    }

    function gameOver() {
        isRunning = false;
        clearInterval(gameLoop);

        const playerName = localStorage.getItem('playerName');
        if (playerName && score > 0) {
            fetch('/PlayZone/SaveScore', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ playerName, score })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success && data.topScores) {
                    const list = document.getElementById('leaderboardList');
                    list.innerHTML = '';
                    data.topScores.forEach((s, i) => {
                        const item = document.createElement('div');
                        item.className = 'leader-item';
                        const name = s.playerName || s.PlayerName || '';
                        const sc = s.score ?? s.Score ?? 0;
                        item.innerHTML = `
                            <div class="leader-rank">${i + 1}</div>
                            <div class="leader-info"><div class="leader-name">${name}</div></div>
                            <div class="leader-score">${sc}</div>
                        `;
                        list.appendChild(item);
                    });
                }
            })
            .catch(e => console.error('Save error:', e));
        }

        finalScoreEl.textContent = score;
        if (score >= bestScore && score > 0) {
            newHighEl.classList.add('active');
        }
        gameOverDialog.classList.add('active');
    }

    function setDirection(nx, ny) {
        if (nx === -dx && ny === -dy) return;
        dx = nx;
        dy = ny;
    }

    function togglePause() {
        if (!isRunning) return;
        isPaused = !isPaused;
        pauseOverlay.classList.toggle('active', isPaused);
    }

    // Keyboard
    document.addEventListener('keydown', e => {
        if (e.key === 'p' || e.key === 'P') {
            togglePause();
            e.preventDefault();
            return;
        }
        if (!isRunning || isPaused) return;
        switch (e.key) {
            case 'ArrowUp': if (dy !== 1) setDirection(0, -1); break;
            case 'ArrowDown': if (dy !== -1) setDirection(0, 1); break;
            case 'ArrowLeft': if (dx !== 1) setDirection(-1, 0); break;
            case 'ArrowRight': if (dx !== -1) setDirection(1, 0); break;
            default: return;
        }
        e.preventDefault();
    });

    // D-Pad
    document.querySelectorAll('.d-pad-btn').forEach(btn => {
        const dir = btn.getAttribute('data-dir');
        function go() {
            if (!isRunning || isPaused) return;
            if (dir === 'up' && dy !== 1) setDirection(0, -1);
            else if (dir === 'down' && dy !== -1) setDirection(0, 1);
            else if (dir === 'left' && dx !== 1) setDirection(-1, 0);
            else if (dir === 'right' && dx !== -1) setDirection(1, 0);
        }
        btn.addEventListener('click', go);
        btn.addEventListener('touchend', e => { e.preventDefault(); go(); }, { passive: false });
    });

    // Touch swipe
    let touchX = 0, touchY = 0;
    canvas.addEventListener('touchstart', e => {
        e.preventDefault();
        touchX = e.touches[0].clientX;
        touchY = e.touches[0].clientY;
    }, { passive: false });

    canvas.addEventListener('touchmove', e => {
        e.preventDefault();
        if (!isRunning || isPaused || !touchX) return;
        const tx = e.touches[0].clientX, ty = e.touches[0].clientY;
        const dX = tx - touchX, dY = ty - touchY;
        if (Math.abs(dX) < 25 && Math.abs(dY) < 25) return;
        if (Math.abs(dX) > Math.abs(dY)) {
            if (dX > 0 && dx !== -1) setDirection(1, 0);
            else if (dX < 0 && dx !== 1) setDirection(-1, 0);
        } else {
            if (dY > 0 && dy !== -1) setDirection(0, 1);
            else if (dY < 0 && dy !== 1) setDirection(0, -1);
        }
        touchX = tx;
        touchY = ty;
    }, { passive: false });

    canvas.addEventListener('touchend', e => {
        e.preventDefault();
        touchX = 0;
        touchY = 0;
    }, { passive: false });

    // Resize
    window.addEventListener('resize', () => {
        resizeCanvas();
        if (isRunning) draw();
    });
});
</script>

</body>
</html>
